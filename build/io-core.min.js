class NodeBindings{constructor(e){Object.defineProperty(this,"node",{value:e,configurable:!0})}get(e){return this[e]=this[e]||new Binding(this.node,e),this[e]}dispose(){for(let e in this)this[e].dispose(),delete this[e];delete this.node}}class Binding{constructor(e,t){this.source=e,this.sourceProp=t,this.targets=[],this.targetsMap=new WeakMap,this.updateSource=this.updateSource.bind(this),this.updateTargets=this.updateTargets.bind(this),this.source.addEventListener(this.sourceProp+"-changed",this.updateTargets)}addTarget(e,t){if(-1===this.targets.indexOf(e)&&this.targets.push(e),this.targetsMap.has(e)){const s=this.targetsMap.get(e);-1===s.indexOf(t)&&(s.push(t),e.addEventListener(t+"-changed",this.updateSource))}else this.targetsMap.set(e,[t]),e.addEventListener(t+"-changed",this.updateSource)}removeTarget(e,t){if(this.targetsMap.has(e)){const s=this.targetsMap.get(e);if(t){const i=s.indexOf(t);-1!==i&&s.splice(i,1),e.removeEventListener(t+"-changed",this.updateSource)}else{for(let t=s.length;t--;)e.removeEventListener(s[t]+"-changed",this.updateSource);s.length=0}0===s.length&&this.targets.splice(this.targets.indexOf(e),1)}}updateSource(e){if(-1===this.targets.indexOf(e.target))return void console.warn("io error: updateSource() should never fire when target is removed from binding.\n        Please file an issue at https://github.com/arodic/io/issues.");const t=e.detail.value;this.source[this.sourceProp]!==t&&(this.source[this.sourceProp]=t)}updateTargets(e){if(e.target!=this.source)return void console.warn("io error: updateTargets() should always originate form source node.\n        Please file an issue at https://github.com/arodic/io/issues.");const t=e.detail.value;for(let e=this.targets.length;e--;){const s=this.targetsMap.get(this.targets[e]);for(let i=s.length;i--;){let o=this.targets[e][s[i]];if(o!==t){if("number"==typeof t&&"number"==typeof o&&isNaN(t)&&isNaN(o))continue;this.targets[e][s[i]]=t}}}}dispose(){this.source.removeEventListener(this.sourceProp+"-changed",this.updateTargets);for(let e in this.targets)this.removeTarget(this.targets[e]),delete this.targets[e]}}class NodeQueue extends Array{constructor(e){super(),Object.defineProperty(this,"node",{value:e,configurable:!0})}queue(e,t,s){const i=this.indexOf(e);-1===i?this.push(e,{property:e,value:t,oldValue:s}):this[i+1].value=t}dispatch(){const e=this.node;if(this.length){for(let t=0;t<this.length;t+=2){const s=this[t],i={detail:this[t+1]};e[s+"Changed"]&&e[s+"Changed"](i),e.dispatchEvent(s+"-changed",i.detail)}e.isNode&&!e.isElement&&e.dispatchEvent("object-mutated",{object:e},!1,window),e.changed(),this.length=0}}dispose(){this.length=0,delete this.node}}class ProtoListeners{constructor(e){for(let t=e.length;t--;){const s=e[t].constructor.listeners;for(let e in s)this[e]=s[e]}}}class Listeners{constructor(e,t){Object.defineProperty(this,"node",{value:e}),Object.defineProperty(this,"propListeners",{value:{}}),Object.defineProperty(this,"activeListeners",{value:{}});for(let e in t)this[e]=t[e]}setPropListeners(e){for(let e in this.propListeners)delete this.propListeners[e];for(let t in e)t.startsWith("on-")&&(this.propListeners[t.slice(3,t.length)]=e[t])}connect(){const e=this.node,t=this.propListeners;for(let t in this){const s="function"==typeof this[t]?this[t]:e[this[t]];e.addEventListener(t,s)}for(let s in t){const i="function"==typeof t[s]?t[s]:e[t[s]];e.addEventListener(s,i)}}disconnect(){const e=this.node,t=this.propListeners;for(let t in this){const s="function"==typeof this[t]?this[t]:e[this[t]];e.removeEventListener(t,s)}for(let s in t){const i="function"==typeof t[s]?t[s]:e[t[s]];e.removeEventListener(s,i)}}dispose(){this.disconnect();const e=this.node,t=this.activeListeners;for(let s in t)for(let i=t[s].length;i--;)e.isElement&&HTMLElement.prototype.removeEventListener.call(e,s,t[s][i]),t[s].splice(i,1)}addEventListener(e,t){const s=this.node,i=this.activeListeners;i[e]=i[e]||[],-1===i[e].indexOf(t)&&(s.isElement&&HTMLElement.prototype.addEventListener.call(s,e,t),i[e].push(t))}removeEventListener(e,t){const s=this.node,i=this.activeListeners;if(void 0!==i[e]){const o=i[e].indexOf(t);-1!==o&&(s.isElement&&HTMLElement.prototype.removeEventListener.call(s,e,t),i[e].splice(o,1))}}dispatchEvent(e,t={},s=!0,i=this.node){if(i instanceof HTMLElement||i===window)HTMLElement.prototype.dispatchEvent.call(i,new CustomEvent(e,{type:e,detail:t,bubbles:s,composed:!0}));else{const s=this.activeListeners;if(void 0!==s[e]){const o=s[e].slice(0);for(let e=0;e<o.length;e++)o[e].call(i,{detail:t,target:i,path:[i]})}}}}class ProtoProperties{constructor(e){const t={};for(let s=e.length;s--;){const i=e[s].constructor.properties;for(let e in i)t[e]?t[e].assign(new Property(i[e])):t[e]=new Property(i[e])}for(let e in t)this[e]=new Property(t[e])}get(e){console.warn("Property",e,"cannot be get before instance is constructed.")}set(e){console.warn("Property",e,"cannot be set before instance is constructed.")}}class Properties{constructor(e,t){Object.defineProperty(this,"node",{value:e});for(let s in t)if(this[s]=t[s].clone(),"object"==typeof this[s].value){const t=this[s].value;t&&t.isNode&&t.connect(e),e.queue(s,t,void 0)}}get(e){return this[e].value}set(e,t){let s=this[e].binding,i=this[e].value,o=t instanceof Binding?t:null;o&&s&&o!==s&&s.removeTarget(this.node,e),o?(o.addTarget(this.node,e),this[e].binding=o,this[e].value=t.source[t.sourceProp],t=t.source[t.sourceProp]):this[e].value=t,t&&t.isNode&&t.connect(this.node),t!==i&&i&&i.isNode&&i.disconnect(this.node),this[e].reflect&&this.node.setAttribute(e,t)}connect(){for(let e in this)this[e].binding&&this[e].binding.addTarget(this.node,e)}disconnect(){for(let e in this)this[e].binding&&this[e].binding.removeTarget(this.node,e)}dispose(){for(let e in this)this[e].binding&&(this[e].binding.removeTarget(this.node,e),delete this[e].binding),delete this[e]}}class Property{constructor(e){null===e||void 0===e?e={value:e}:"function"==typeof e?e={type:e}:e instanceof Array?e={type:Array,value:[...e]}:e instanceof Binding?e={binding:e,value:e.value}:"object"!=typeof e&&(e={value:e,type:e.constructor}),this.assign(e)}assign(e){void 0!==e.value&&(this.value=e.value),void 0!==e.type&&(this.type=e.type),void 0!==e.reflect&&(this.reflect=e.reflect),void 0!==e.binding&&(this.binding=e.binding),this.enumerable=void 0===e.enumerable||e.enumerable}clone(){const e=new Property(this);return void 0===e.type&&void 0!==e.value&&null!==e.value&&(e.type=e.value.constructor),e.type===Array&&e.value&&(e.value=[...e.value]),void 0===e.value&&e.type&&(e.type===Boolean?e.value=!1:e.type===String?e.value="":e.type===Number?e.value=0:e.type===Array?e.value=[]:e.type===Object?e.value={}:e.type!==HTMLElement&&e.type!==Function&&(e.value=new e.type)),e}}const IoNodeMixin=e=>{const t=class extends e{static get properties(){return{}}get bindings(){}constructor(e={}){super(e),this.constructor.prototype.__registered||this.constructor.Register(),Object.defineProperty(this,"__nodeBindings",{value:new NodeBindings(this)}),Object.defineProperty(this,"__nodeQueue",{value:new NodeQueue(this)}),Object.defineProperty(this,"__properties",{value:new Properties(this,this.__protoProperties)}),Object.defineProperty(this,"__listeners",{value:new Listeners(this,this.__protoListeners)});for(let e=0;e<this.__functions.length;e++)this[this.__functions[e]]=this[this.__functions[e]].bind(this);this.__listeners.setPropListeners(e,this),this.compose&&this.applyCompose(this.compose),this.setProperties(e)}connect(e){this._owner=this._owner||[],-1===this._owner.indexOf(e)&&(this._owner.push(e),this.__connected||this.connectedCallback())}disconnect(e){-1!==this._owner.indexOf(e)&&this._owner.splice(this._owner.indexOf(e),1),0===this._owner.length&&this.__connected&&this.disconnectedCallback()}preventDefault(e){e.preventDefault()}changed(){}bind(e){return this.__nodeBindings.get(e)}set(e,t){if(this[e]!==t){const s=this[e];this[e]=t,this.dispatchEvent(e+"-set",{property:e,value:t,oldValue:s},!1)}}setProperties(e){for(let t in e){if(void 0===this.__properties[t])continue;const s=this.__properties[t].value;this.__properties.set(t,e[t]);const i=this.__properties[t].value;i!==s&&this.queue(t,i,s)}if(this.className=e.className||"",e.style)for(let t in e.style)this.style[t]=e.style[t],this.style.setProperty(t,e.style[t]);this.__connected&&this.queueDispatch()}applyCompose(e){for(let t in e){const s=e[t];this[t].setProperties(s),this.addEventListener(t+"-changed",e=>{e.detail.oldValue&&e.detail.oldValue.dispose(),e.detail.value.setProperties(s)})}}onObjectMutation(e){for(let t=this.__objectProps.length;t--;){const s=this.__objectProps[t];if(this.__properties[s].value===e.detail.object)return this[s+"Mutated"]&&this[s+"Mutated"](e),void this.changed()}}connectedCallback(){this.__listeners.connect(),this.__properties.connect(),this.__connected=!0,this.__objectProps.length&&window.addEventListener("object-mutated",this.onObjectMutation),this.queueDispatch()}disconnectedCallback(){this.__listeners.disconnect(),this.__properties.disconnect(),this.__connected=!1,this.__objectProps.length&&window.removeEventListener("object-mutated",this.onObjectMutation)}dispose(){this.__nodeQueue.dispose(),this.__nodeBindings.dispose(),this.__listeners.dispose(),this.__properties.dispose()}addEventListener(e,t){this.__listeners.addEventListener(e,t)}removeEventListener(e,t){this.__listeners.removeEventListener(e,t)}dispatchEvent(e,t,s=!1,i){this.__listeners.dispatchEvent(e,t,s,i)}queue(e,t,s){this.__nodeQueue.queue(e,t,s)}queueDispatch(){this.__nodeQueue.dispatch()}};return t.Register=Register,t},Register=function(){Object.defineProperty(this.prototype,"__registered",{value:!0});const e=[];let t=this.prototype;for(;t&&t.constructor!==HTMLElement&&t.constructor!==Object;)e.push(t),t=t.__proto__;Object.defineProperty(this.prototype,"isNode",{value:t.constructor!==HTMLElement}),Object.defineProperty(this.prototype,"isElement",{value:t.constructor===HTMLElement}),Object.defineProperty(this.prototype,"__protochain",{value:e}),Object.defineProperty(this.prototype,"__protoProperties",{value:new ProtoProperties(this.prototype.__protochain)}),Object.defineProperty(this.prototype,"__protoListeners",{value:new ProtoListeners(this.prototype.__protochain)}),Object.defineProperty(this.prototype,"__properties",{value:this.prototype.__protoProperties});const s=[];for(let e=this.prototype.__protochain.length;e--;){const t=this.prototype.__protochain[e],i=Object.getOwnPropertyNames(t);for(let e=0;e<i.length;e++)"constructor"!==i[e]&&(Object.getOwnPropertyDescriptor(t,i[e]).get||"function"==typeof t[i[e]]&&"anonymous"!==t[i[e]].name&&-1===s.indexOf(i[e])&&s.push(i[e]))}Object.defineProperty(this.prototype,"__functions",{value:s}),Object.defineProperty(this.prototype,"__objectProps",{value:[]});const i=[Boolean,String,Number,HTMLElement,Function,void 0];for(let e in this.prototype.__protoProperties){let t=this.prototype.__protoProperties[e].type;"$"!==e&&-1==i.indexOf(t)&&this.prototype.__objectProps.push(e)}for(let e in this.prototype.__protoProperties){const t="_"!==e.charAt(0),s=!(!1===this.prototype.__protoProperties[e].enumerable);Object.defineProperty(this.prototype,e,{get:function(){return this.__properties[e].value},set:function(s){if(this.__properties[e].value===s)return;const i=this.__properties.get(e);this.__properties.set(e,s),s=this.__properties.get(e),t&&(this.queue(e,s,i),this.__connected&&this.queueDispatch())},enumerable:s&&t,configurable:!0})}};IoNodeMixin.Register=Register;class IoNode extends(IoNodeMixin(Object)){}class IoElement extends(IoNodeMixin(HTMLElement)){static get properties(){return{id:{type:String,enumerable:!1},tabindex:{type:String,reflect:!0,enumerable:!1},contenteditable:{type:Boolean,reflect:!0,enumerable:!1},title:{type:String,reflect:!0,enumerable:!1},role:{type:String,reflect:!0,enumerable:!1},$:{type:Object}}}connectedCallback(){super.connectedCallback();for(let e in this.__properties)this.__properties[e].reflect&&this.setAttribute(e,this.__properties[e].value);"function"==typeof this.resized&&(this.resized(),ro?ro.observe(this):window.addEventListener("resize",this.resized))}disconnectedCallback(){super.disconnectedCallback(),"function"==typeof this.resized&&(ro?ro.unobserve(this):window.removeEventListener("resize",this.resized))}dispose(){super.dispose(),delete this.parent,this.children.lenght=0}template(e,t){this.traverse(buildTree()(["root",e]).children,t||this)}traverse(e,t){const s=t.children;for(;s.length>e.length;){const e=s[s.length-1];let i=Array.from(e.querySelectorAll("*"));t.removeChild(e);for(let e=i.length;e--;)i[e].dispose&&i[e].dispose();e.dispose&&e.dispose()}if(s.length<e.length){const i=document.createDocumentFragment();for(let t=s.length;t<e.length;t++)i.appendChild(constructElement(e[t]));t.appendChild(i)}for(let i=0;i<s.length;i++)if(s[i].localName!==e[i].name){const o=s[i];t.insertBefore(constructElement(e[i]),o);let n=Array.from(o.querySelectorAll("*"));t.removeChild(o);for(let e=n.length;e--;)n[e].dispose&&n[e].dispose();o.dispose&&o.dispose()}else if(s[i].className="",s[i].hasOwnProperty("__properties"))s[i].setProperties(e[i].props),s[i].__listeners.setPropListeners(e[i].props,s[i]),s[i].__listeners.connect();else{for(let t in e[i].props)if("style"===t)for(let o in e[i].props.style)s[i].style.setProperty(o,e[i].props[t][o]);else s[i][t]=e[i].props[t];s[i].__listeners.setPropListeners(e[i].props,s[i]),s[i].__listeners.connect()}for(let t=0;t<e.length;t++)e[t].props.id&&(this.$[e[t].props.id]=s[t]),e[t].children&&"string"==typeof e[t].children?s[t].innerText=e[t].children:e[t].children&&"object"==typeof e[t].children&&this.traverse(e[t].children,s[t])}setAttribute(e,t){!0===t?HTMLElement.prototype.setAttribute.call(this,e,""):!1===t||""===t?this.removeAttribute(e):"string"!=typeof t&&"number"!=typeof t||this.getAttribute(e)!==String(t)&&HTMLElement.prototype.setAttribute.call(this,e,t)}}const warning=document.createElement("div");let ro;function html(e){let t={string:"",vars:{}};for(let s=0;s<e.length;s++)t.string+=e[s]+(arguments[s+1]||"");let s=t.string.match(/-{2}?([a-z][a-z0-9]*)\b[^;]*;?/gi);if(s)for(let e=0;e<s.length;e++){let i=s[e].split(":");2===i.length&&(t.vars[i[0].trim()]=i[1].trim())}return t}warning.innerHTML='\nNo support for custom elements detected! <br />\nSorry, modern browser is required to view this page.<br />\nPlease try <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a>,\n<a href="https://www.google.com/chrome/">Chrome</a> or\n<a href="https://www.apple.com/lae/safari/">Safari</a>',IoElement.Register=function(){IoNodeMixin.Register.call(this);const e=this.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();Object.defineProperty(this,"localName",{value:e}),Object.defineProperty(this.prototype,"localName",{value:e}),void 0!==window.customElements?(window.customElements.define(e,this),initStyle(this.prototype.__protochain)):document.body.insertBefore(warning,document.body.children[0])},void 0!==window.ResizeObserver&&(ro=new ResizeObserver(e=>{for(let t of e)t.target.resized()}));const constructElement=function(e){let t=window.customElements?window.customElements.get(e.name):null;if(t)return new t(e.props);let s=document.createElement(e.name);for(let t in e.props)if("style"===t)for(let i in e.props[t])s.style[i]=e.props[t][i];else s[t]=e.props[t];return Object.defineProperty(s,"__listeners",{value:new Listeners(s)}),s.__listeners.setPropListeners(e.props,s),s.__listeners.connect(),s},clense=(e,t)=>t?"string"==typeof t[0]?[...e,t]:[...e,...t]:e,buildTree=()=>e=>e&&"object"==typeof e[1]&&!Array.isArray(e[1])?{name:e[0],props:e[1],children:Array.isArray(e[2])?e[2].reduce(clense,[]).map(buildTree()):e[2]||""}:buildTree()([e[0],{},e[1]||""]),_stagingElement=document.createElement("div");function initStyle(e){let t=e[0].constructor.name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();for(let s=e.length;s--;){let i=e[s].constructor.style;if(i){i.string=i.string.replace(new RegExp(":host","g"),t);for(let e in i.vars)i.string=i.string.replace(new RegExp(e,"g"),e.replace("--","--"+t+"-"));_stagingElement.innerHTML=i.string;let e=_stagingElement.querySelector("style");e.setAttribute("id","io-style-"+t+"-"+s),document.head.appendChild(e)}}}"serviceWorker"in navigator||console.error("No Service Worker support!"),"PushManager"in window||console.error("No Push API Support!");class IoServiceLoader extends IoNode{static get properties(){return{path:"service.js",serviceWorker:void 0,granted:window.Notification&&"granted"===window.Notification.permission,subscription:""}}constructor(e){super(e),this.init()}async init(){const e=await navigator.serviceWorker.register(this.path);e.update(),navigator.serviceWorker.addEventListener("message",this.onServiceWorkerMessage),e.active?this.serviceWorker=e:e.addEventListener("activate",()=>{this.serviceWorker=e})}serviceWorkerChanged(){this.granted&&this.subscribe()}subscribe(){navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"subscribe"})}async requestNotification(){this.granted="granted"===await window.Notification.requestPermission(),this.granted&&this.subscribe()}onServiceWorkerMessage(e){const t=JSON.parse(e.data);t.subscription&&(this.subscription=JSON.stringify(t.subscription))}}const nodes={};let hashes={};const parseHashes=function(){return window.location.hash.substr(1).split("&").reduce(function(e,t){const s=t.split("=");return e[s[0]]=s[1],e},{})},getHashes=function(){hashes=window.location.hash.substr(1).split("&").reduce(function(e,t){const s=t.split("=");return e[s[0]]=s[1],e},{});for(let e in hashes)nodes[e]&&""!==nodes[e]&&(isNaN(hashes[e])?"true"===hashes[e]||"false"===hashes[e]?nodes[e].value=JSON.parse(hashes[e]):nodes[e].value=hashes[e]:nodes[e].value=JSON.parse(hashes[e]))},setHashes=function(e){let t="";for(let s in nodes)(nodes[s].hash||e)&&void 0!==nodes[s].value&&""!==nodes[s].value&&nodes[s].value!==nodes[s].defValue&&("string"==typeof nodes[s].value?t+=s+"="+nodes[s].value+"&":t+=s+"="+JSON.stringify(nodes[s].value)+"&");t=t.slice(0,-1),window.location.hash=t,window.location.hash||history.replaceState({},document.title,".")};window.addEventListener("hashchange",getHashes,!1),getHashes();class IoStorageNode extends IoNode{static get properties(){return{key:String,value:void 0,defValue:void 0,hash:Boolean}}constructor(e,t){super(e),this.defValue=t;const s=hashes[this.key],i="/"!==window.location.pathname?window.location.pathname+this.key:this.key,o=localStorage.getItem(i);this.value=void 0!==s?JSON.parse(s):null!==o&&void 0!==o?JSON.parse(o):t}valueChanged(){setHashes();const e="/"!==window.location.pathname?window.location.pathname+this.key:this.key;null===this.value||void 0===this.value?localStorage.removeItem(e):localStorage.setItem(e,JSON.stringify(this.value))}}function IoStorage(e,t,s){return nodes[e]||(nodes[e]=new IoStorageNode({key:e,hash:s},t),nodes[e].binding=nodes[e].bind("value"),nodes[e].connect(window),nodes[e].valueChanged()),nodes[e].binding}export{IoNodeMixin,IoNode,IoElement,html,Binding,NodeBindings,IoServiceLoader,IoStorage,nodes as storageNodes};